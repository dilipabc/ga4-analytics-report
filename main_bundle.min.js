/*! GA4 Analytics Report 2024-05-11 */
"use strict";const _url=require("url"),axios=require("axios"),qs=require("querystring");class GA4AnalyticsReport{scopes={authURL:"https://accounts.google.com",tokenURL:"https://oauth2.googleapis.com/token",analyticsReadonlyURL:"https://www.googleapis.com/auth/analytics.readonly"};grantType={newToken:"authorization_code",refreshToken:"refresh_token"};accessType="offline";responseType="code";dimensions=[{name:"city"},{name:"country"},{name:"date"},{name:"region"},{name:"streamName"}];metrics=[{name:"totalUsers"}];tartDate="30daysAgo";endDate="yesterday";dateRanges=[{startDate:this.tartDate,endDate:this.endDate}];dimensionFilter={};orderBys=[];constructor(e,t){this.client_id=e,this.client_secret=t}createAuthUrl(e="",t=""){if(!this.client_id)throw Error("Client id is empty");var r;if(e)return(r=new _url.URL(this.scopes.authURL)).pathname="/o/oauth2/v2/auth",r.searchParams.append("response_type",this.responseType),r.searchParams.append("access_type",this.accessType),r.searchParams.append("scope",t||this.scopes.analyticsReadonlyURL),r.searchParams.append("client_id",this.client_id),r.searchParams.append("redirect_uri",e),decodeURI(r.toString());throw Error("Redirect uri is empty")}async createNewToken(e={}){if(!this.client_id)throw Error("Client id is empty");if(!this.client_secret)throw Error("Client secret is empty");if(!e.code)throw Error("Code is empty");if(!e.redirect_uri)throw Error("Redirect uri is empty");try{return await axios.post(this.scopes.tokenURL,qs.stringify({grant_type:this.grantType.newToken,client_id:this.client_id,redirect_uri:e.redirect_uri,code:e.code,client_secret:this.client_secret}),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})}catch(e){throw Error("This code has expired or already used. Generate a new one and try again.")}}async refreshOldToken(e){if(!this.client_id)throw Error("Client id is empty");if(!this.client_secret)throw Error("Client secret is empty");if(!e)throw Error("Refresh token is empty");try{return await axios.post(this.scopes.tokenURL,qs.stringify({client_id:this.client_id,client_secret:this.client_secret,refresh_token:e,grant_type:this.grantType.refreshToken}),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})}catch(e){throw Error("This refresh token has expired. Generate a new one and try again")}}async generateGA4Report(e={}){let t;if(!e.property_id)throw Error("Property id is empty");if(e.bearer_access_token)return e.dimensions&&0<e.dimensions.length&&(this.dimensions=e.dimension),e.metrics&&0<e.metrics.length&&(this.metrics=e.metrics),e.dateRanges&&0<e.dateRanges.length&&(this.dateRanges=e.dateRanges),t=e.dimensionFilter?{property:"properties/"+e.property_id,dimensions:this.dimensions,metrics:this.metrics,dateRanges:this.dateRanges,dimensionFilter:e.dimensionFilter,orderBys:this.orderBys}:{property:"properties/"+e.property_id,dimensions:this.dimensions,metrics:this.metrics,dateRanges:this.dateRanges,orderBys:this.orderBys},axios.post(`https://analyticsdata.googleapis.com/v1beta/properties/${e.property_id}:runReport`,t,{headers:{Authorization:"Bearer "+e.bearer_access_token,"Content-Type":"application/json"}});throw Error("Bearer access token is empty")}}module.exports=GA4AnalyticsReport;